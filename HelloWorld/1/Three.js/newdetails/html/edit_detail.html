<!DOCTYPE html>
<html>
<head>
	<title>编辑详情</title>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
	<link rel="stylesheet" type="text/css" href="../css/mui.min.css">
	<link rel="stylesheet" type="text/css" href="../css/common.css">
	<style>
		.mui-segmented-control.mui-segmented-control-inverted~.mui-slider-progress-bar {
		  background-color: #cd3829;
		}
		.mui-slider-progress-bar {
		  height: 3px;
		  width:98%;
  			margin-left: 1%;
 		 }
 		 .mui-detail-btn .mui-detail-btn {
		  width: 70% !important;
		}
		.mui-comment .icon-zan {
		  width: 16px !important;
		}
		.mui-segmented-control .mui-control-item {
		  display: initial;
		  }
		  
		  .mui-slider-item {
			   border-top: 0px !important; 
			  border-bottom: 0px !important;
			}
			.mui-control-content {
				/*background-color: white;*/
				min-height: 215px;
			}
			.mui-tab {
			  padding: 0px 0;
			}
			.mui-detail-title .mui-icon {
				  font-size: 21px;
				    float: right;
				      margin-right: 10px;
				}
				#addDiv{
					  /*position: fixed;
				  right: 15px;
				    top: 8px;*/
				  z-index: 1000;
				    /*border-left: 3px solid #cd3829;*/
				      width: 100%;
				}
			.edit{
				color: brown;
			}
			.save{
				  color: chartreuse;
			}
			.titleEditive{
				  border: 1px solid rgb(208, 136, 136);
			}
			.titleNoEditive{
				
			}
			.contentEditive{
				  border: 1px solid rgb(208, 136, 136);
			}
			.mui-spitslot-textarea_edit {
			  padding: 15px 10px;
			  /*position: absolute;
			  top: 37px;
			  right: 100px;*/
			  z-index: 1000;
			    width: 100px;
			      margin-top: 10px;
			}
			.mui-spitslot-textarea_edit .mui-spitslot-vedio {
			  /* position: absolute; */
			  right: 23px;
			  bottom: 24px;
			  background: url(../images/tab_vedio_icon.png)no-repeat center 2px;
			  background-size: 22px 19px;
			  padding-top: 23px;
			  font-size: 11px;
			  color: #b3b3b3;
			}
			.mui-spitslot-textarea_edit input{
				  opacity: 0;
				  position: absolute;
  				  top: 60px;
			}
			.mui-badge {
			  background-color: rgba(244, 19, 78, 0.15);
			}
	</style>
</head>
<body>
<header class="mui-bar mui-bar-nav mui-search-box">
			<a href="javascript:void(0);" class="mui-back mui-action-back"></a>
				<h4 class="mui-title">详情编辑</h4>
		</header>
<!-- banner -->


<!-- 详情 游记 以文会友 -->
<div class="mui-content" >
	<div id="fileDiv" class="mui-spitslot-textarea_edit">
	<a class="mui-spitslot-vedio" href="javascript:void(0);">添加轮播图片
		<form role="form" id="myForm" action="" method="post" enctype="multipart/form-data">
			<input type="file" name="fulAvatar" class="upload_img" onchange="uploadByForm(this)"/>
		</form>
	</a>
	<div id="preview">
						<!--<div><img />  <span class="mui-badge">1
					</span></div>
						-->
					</div>
	</div>
<div id="addDiv" class="mui-btn ">
	<span class="mui-icon mui-icon-plusempty " id="add">添加
</div>
	<div id="slider" class="mui-slider">
		<div id="sliderSegmentedControl" class="mui-slider-indicator mui-segmented-control mui-segmented-control-inverted">
		
	</div>
	<div id="sliderProgressBar" class="mui-slider-progress-bar mui-col-xs-4"></div>
	<div class="mui-slider-group">
					<div id="item1mobile" class="mui-slider-item mui-control-content mui-active">
						<div id="scroll1" class="mui-scroll-wrapper">
							<div class="mui-scroll">
		<!--编辑的区域-->
		<div class="mui-row mui-detail mb10" id="editorContainer">
			<div class="mui-col-xs-12">
				<p class="mui-detail-title"><b>景点介绍</b> <span class="mui-icon mui-icon-trash delete"></span><span class="mui-icon mui-icon-checkmarkempty save"></span><span class="mui-icon mui-icon-compose edit"></span></p>
				<p class="mui-detail-content currentScenicContent "  id="currentScenicContent">
					深圳市凤凰山森林公园位于深圳市宝安区西南部的福永镇凤凰村 ，跨福永、西乡、沙井、公明、石岩五个街道办事处，是深圳市规划重点建设的八大森林公园之一，目标是建成深圳最具吸引力的郊野森林公园。景区已建成福永凤凰主入口及沙井观音庙(洪田火山郊野公园)、西乡黄麻布、福永虎背山三个次入口。
				</p>
				
			</div>
			<!--<div class="mui-col-xs-12">
				<p class="mui-detail-title"><b>历史人物</b></p>
				<p class="mui-detail-content"  >
					深圳市凤凰山森林公园位于深圳市宝安区西南部的福永镇凤凰村 ，<img src="../images/feel.png" >跨福永、西乡、沙井、公明、石岩五个街道办事处，是深圳市规划重点建设的八大森林公园之一，目标是建成深圳最具吸引力的郊野森林公园。景区已建成福永凤凰主入口及沙井观音庙(洪田火山郊野公园)、西乡黄麻布、福永虎背山三个次入口。
				</p>
				
			</div>-->
		</div>
	
		
	
	
		</div>
	</div>
	</div>
	
	
					
	
	
 </div></div>
</div>


<div class="mui-fixed-comment" id="editorDiv" onmouseover="rotateDIV()" >
	<a href="javascript:void(0);" id="complaints">
		<img src="../images/icon_edit.png" >
	</a>
</div>



<script type="text/javascript" src="../js/mui.min.js"></script>
<script src="../../js/tween/TweenLite.js"></script>
<script src="../../mobile/layer.js"></script>
	<script src="../../js/path.js"></script>
	<script src="../../js/jquery-1.9.1.js"></script>
<script type="text/javascript">
	var picHtml = [];//上传的图标内容标签
		mui.init({
			swipeBack: false
		});
		mui.ready(function(){
		  		
		  	});
		(function($S) {
			var scroll = $S('.mui-scroll-wrapper').scroll({
					indicators: true //是否显示滚动条
				});
				console.log(scroll);
				var mui_slider_progress_bar  = document.querySelector('.mui-slider-progress-bar');
			document.getElementById('slider').addEventListener('slide', function(e) {
				console.log(e.detail.slideNumber );
				if(e.detail.slideNumber == 0){
					mui_slider_progress_bar.style.marginLeft = '23%';
					mui_slider_progress_bar.style.width='10%';
				}else if(e.detail.slideNumber == 1){
					mui_slider_progress_bar.style.marginLeft = '35%';
					mui_slider_progress_bar.style.width='10%';
				}else if(e.detail.slideNumber == 2){
					mui_slider_progress_bar.style.marginLeft = '44%';
					mui_slider_progress_bar.style.width='15%';
				}
				initHeight();
			});
			
				
			//吐槽
			var complaints = document.getElementById("complaints");
			complaints.addEventListener('tap',function(e){
				//mui.openWindow("");//spitslot_create.html
			});
			
			var mui_scroll_wrapper = document.querySelectorAll('.mui-scroll-wrapper');
			var isGo = false;
			for(var i=0,m=mui_scroll_wrapper.length;i<m;i++){
				mui_scroll_wrapper[i].addEventListener('scroll', function (e ) { 
//				     console.log(e.detail.y,document.body.scrollTop); 
				     if(e.detail.y>0 && !isGo){
//				     	document.body.scrollTop = 0;
						isGo = true;
						TweenLite.to(document.body,1,{scrollTop:0,onComplete:function(){
//							console.log('往');
							isGo = false;
						}});
				     }else if(e.detail.y<-100 && !isGo){
				     	isGo = true;
//				     	document.body.scrollTop = 130;
						TweenLite.to(document.body,1,{scrollTop:200,onComplete:function(){
//							console.log('往');
							isGo = false;
						}});
				     }
				}) 
			}
//			document.querySelector('.mui-scroll-wrapper' ).addEventListener('scroll', function (e ) { 
//		      console.log(scroll); 
//		    }) 
			
			//控制banner img
//			var bannerImg = document.querySelector('.mui-slider .mui-slider-group .mui-slider-item img');
			initHeight();
			function initHeight(){
				//var firstContent = document.getElementById("firstContent");
				var sliderSegmentedControl = document.getElementById("sliderSegmentedControl");
				var mui_control_content  = document.querySelectorAll('.mui-control-content');
//				console.log(mui_control_content,window.innerHeight,firstContent.offsetHeight,sliderSegmentedControl.offsetHeight);
				for(var i=0,m=mui_control_content.length;i<m;i++){
					mui_control_content[i].style.minHeight = window.innerHeight -151 /*- sliderSegmentedControl.offsetHeight+ (window.innerHeight<650?200:100 )*/+'px';
				}
				$('body')[0].style.minHeight = window.innerHeight + (window.innerHeight<650?100:10 )+'px';
			}
			
			
			var currentInfo = localStorage.getItem("currentInfo");
			var currentScenicContent = document.getElementById("currentScenicContent");
			if(currentInfo){
				currentInfo = JSON.parse(currentInfo);
				//currentScenic.innerHTML = currentInfo.title;
				currentScenicContent.innerHTML = currentInfo.summary;
				currentInfo.imgbox = JSON.parse(currentInfo.imgbox);
				
				
				//如果有客户提供的景点详情，并且已经通过审核了，那么就可以显示
					if(currentInfo.audit_status!=2  && currentInfo.editor_content){//表示不在审核中可以显示
						//var mm = '[{"title":"景点介绍","content":"深圳香蜜湖水上乐园，地处深圳福田中心区，紧靠深南大道，设备最先进的具有国际一流水准的大型水上乐园，深圳第一个新颖有趣的戏水乐园。除了商业割据香蜜湖，地产商蚕食香蜜湖地块，也使得香蜜湖作为旅游用地的功能逐渐式微。香蜜湖已经是深圳乃至整个华南的豪宅聚居区之一，该片区空气质量上乘，环境景观绝佳，人居条件远远优于其他区域。有着“都市绿肺”之称的香蜜湖地块，成了“地产巨头必战之地”、“高品质城市综合社区”、“深圳顶级豪宅集中区域”等已成了香蜜湖的代名词。内设16个游乐项目，主要有登高滑道、高速滑道、组合滑道、冲浪滑道、雪山滑道、造浪池、漂流河、激流探险、儿童戏水池、儿童反斗乐园、跳水池、休闲池、按摩池、游泳池等。"}]'
						currentInfo.editor_content = currentInfo.editor_content.split('@#|5@');
						$('#editorContainer').empty();
//						console.log(currentInfo.editor_content,JSON.parse("[{\"title\":\"景点介绍\",\"content\":\"深圳香蜜湖水上乐园，地处深圳福田中心区，紧靠深南大道，设备最先进的具有国际一流水准的大型水上乐园，深圳第一个新颖有趣的戏水乐园。除了商业割据香蜜湖，地产商蚕食香蜜湖地块，也使得香蜜湖作为旅游用地的功能逐渐式微。香蜜湖已经是深圳乃至整个华南的豪宅聚居区之一，该片区空气质量上乘，环境景观绝佳，人居条件远远优于其他区域。有着“都市绿肺”之称的香蜜湖地块，成了“地产巨头必战之地”、“高品质城市综合社区”、“深圳顶级豪宅集中区域”等已成了香蜜湖的代名词。内设16个游乐项目，主要有登高滑道、高速滑道、组合滑道、冲浪滑道、雪山滑道、造浪池、漂流河、激流探险、儿童戏水池、儿童反斗乐园、跳水池、休闲池、按摩池、游泳池等。\"},{\"title\":\"标\",\"content\":\"内容s\"}]"));
						for( var i = 0 , m = currentInfo.editor_content.length ; i < m ; i++  ){
							if(!currentInfo.editor_content[i]||currentInfo.editor_content[i]=="")continue;
							var item = (currentInfo.editor_content[i]).split('@*|2@');	
							console.log(item);
							$('#editorContainer').append('<div class="mui-col-xs-12">'
								+'<p class="mui-detail-title"><b>'+item[0]+'</b>  <span class="mui-icon mui-icon-trash delete"></span><span class="mui-icon mui-icon-checkmarkempty save"></span><span class="mui-icon mui-icon-compose edit"></span></p>'
								+'<p class="mui-detail-content currentScenicContent"  >'
								+	item[1]
								+'</p>'
							+'</div>');
							var len = $('#editorContainer').find(".mui-col-xs-12").length;
							addEvent($($('#editorContainer').find(".mui-col-xs-12")[len-1]));
						}
						
					}else{
						addEvent($('#editorContainer'));
					}
			}
			//编辑的区域容器
			
			//
			//添加条目
			var addBtn = document.getElementById("addDiv");
			addBtn.addEventListener('tap',function(){
				$('#editorContainer').append('<div class="mui-col-xs-12">'
				+'<p class="mui-detail-title"><b>标题</b> <span class="mui-icon mui-icon-trash delete"></span><span class="mui-icon mui-icon-checkmarkempty save"></span><span class="mui-icon mui-icon-compose edit"></span></p>'
				+'<p class="mui-detail-content currentScenicContent"  >'
				+	'内容'
				+'</p>'
			+'</div>');
				var len = $('#editorContainer').find(".mui-col-xs-12").length;
				addEvent($($('#editorContainer').find(".mui-col-xs-12")[len-1]));
			
			
			
			});
			
			
			function addEvent(p){console.log(p)
				p.find('.edit').each(function(index,item){
						item.addEventListener('tap',function(){
						$(this).parents('.mui-col-xs-12').find('b').attr('contenteditable',"true");
						$(this).parents('.mui-col-xs-12').find('b').addClass('titleEditive');
						$(this).parents('.mui-col-xs-12').find('.currentScenicContent').attr('contenteditable',"true");
						$(this).parents('.mui-col-xs-12').find('.currentScenicContent').addClass('contentEditive');
						console.log($(this).parents('.mui-col-xs-12'));
						})
				});
				p.find('.save').each(function(index,item){
						item.addEventListener('tap',function(){
							$(this).parents('.mui-col-xs-12').find('b').attr('contenteditable',"false");
							$(this).parents('.mui-col-xs-12').find('b').removeClass('titleEditive');
							$(this).parents('.mui-col-xs-12').find('.currentScenicContent').attr('contenteditable',"false");
							$(this).parents('.mui-col-xs-12').find('.currentScenicContent').removeClass('contentEditive');
							console.log($(this).parents('.mui-col-xs-12'));
							var editor_content = "";
							$('#editorContainer').find(".mui-col-xs-12").each(function(j,a){
//								editor_content.push({title:$(a).find('b').text(),content:$(a).find('.currentScenicContent').html()})
								editor_content+= $(a).find('b').text()+"@*|2@"+$(a).find('.currentScenicContent').html()+'@#|5@';
							});
							console.log(JSON.stringify(editor_content),typeof JSON.stringify(editor_content));
							mui.confirm('确定提交！','温馨提示',['取消','确定'],function(e){
								if(e.index == 1){//确定
									humanAjax(JS_PATH+'/list/update',{
										data:{
											id:currentInfo.id,
											editor_content:"'"+editor_content+"'"//非得要加豆豆否则mysql不当字符串儿
											//editor_content:"\""+JSON.stringify(editor_content)+"\""
										},
										crossDomain :true,
										dataType:'json',//服务器返回json格式数据
										type:'post',//HTTP请求类型
										success:function(data){
											if(data.code==200)
												mui.toast(data.msg);
										},error:function(e){
											
										}
									});
								}
							});
							
						})
					
				});
				p.find('.delete').each(function(index,item){
						item.addEventListener('tap',function(){
							var othis = this;
							mui.confirm('确定删除！','温馨提示',['取消','确定'],function(e){
								if(e.index == 1){//确定
									humanAjax(JS_PATH+'/list/update',{
										data:{
											id:currentInfo.id,
											editor_content:"'[]'"//非得要加豆豆否则mysql不当字符串儿
										},
										crossDomain :true,
										dataType:'json',//服务器返回json格式数据
										type:'post',//HTTP请求类型
										success:function(data){
											if(data.code==200){
												mui.toast("删除成功");
												$(othis).parents('.mui-col-xs-12').remove();
											}
												
										},error:function(e){
											
										}
									});
									
									
									
								}
							});
						})
					
				});
				
			}
			
			
		})(mui);
		//控制编辑图标旋转
		var editorDiv = document.getElementById('editorDiv');
		editorDiv.addEventListener('touchmove',function(){
			rotateDIV();
		})
		var rotate = 0,rtime;
		rotateDIV();
		function rotateDIV(){
			if(!rtime){
				rtime = setInterval(function(){
					rotate+=2;
					if(rotate>360){
						rotate=0;
						clearInterval(rtime);
						rtime = 0;
					}
					$('#editorDiv').css('transform', 'rotate('+rotate+'deg)');
				},1);
			}
			
		}
		
		
		
		
		var picNum = 0;//上传图片数量
		  	
		  	/**
		     * ajax 上传。这里主要是上传图片。
		     */
			    function uploadByForm(target){
			    	if(picNum>3){
			    		mui.toast("提交的轮播图目前不能超过4张!");
			    		return;
			    	}
			    	
			    	function validate_img(a){
						 var file = a;
						 if(!/.(gif|jpg|jpeg|png|GIF|JPG|png)$/.test(file)){
						  alert("图片类型必须是.gif,jpeg,jpg,png中的一种");
						  return false;
						}else{
						     var image = new Image();
						     image.onload = function(){
						     	var height = image.height;
							     var width = image.width;
							     var filesize = image.fileSize;
							      alert(height+"x.."+filesize);
							     if(width>780 && height>780 /*&& filesize>102400*/){
							      alert('请上传780*780像素 或者大小小于100k的图片');
							      return false;
							     }else{
							     	alert("图片通过");
						 			return true;
							     }
						     }
						     image.src = file;
						     
						     
						 }
						 
						}
			    	
			    	
			    	var formData = new FormData($("#myForm")[0]);//获取表单数据
			    	$Ajax(JS_PATH+'/upload/uploader',{
							data:formData,
							crossDomain :true,
							dataType:'json',//服务器返回json格式数据
							type:'post',//HTTP请求类型
							success:function(data){
								if(data.code == 200){
									
										mui.toast("图片提交成功");
										$('#preview').append('<div style="float: left;width: 20%;margin-top: 5px;  margin-left: 20px;"><img style="width: 28px;height: 28px;" src="'+data.newPath+'"/>  <span class="mui-badge" style="position: relative;top:-46px;  right: -20px;">'+(++picNum)+'</span></div>');
										picHtml.push(data.newPath);
			    						
								}else{
									mui.toast("提交失败");
								}
								
							},error:function(e){
								mui.toast("系统出错");
							}
						},true,"上传中");
			    }
		
</script>
</body>
</html>