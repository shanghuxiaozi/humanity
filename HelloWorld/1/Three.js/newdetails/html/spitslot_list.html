<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>吐槽记录</title>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
		<link href="../css/mui.min.css" rel="stylesheet"/>
		<link href="../css/common.css" rel="stylesheet" />

		<style rel="stylesheet">
			body{background-color: #fff;}
			/*下拉上拉刷新*/
				.mui-pull-top-tips {
				position: absolute;
				top: -20px;
				left: 50%;
				margin-left: -25px;
				width: 40px;
				height: 40px;
				border-radius: 100%;
				z-index: 1;
			}
			.mui-bar~.mui-pull-top-tips {
				top: 24px;
			}
			.mui-pull-top-wrapper {
				width: 42px;
				height: 42px;
				display: block;
				text-align: center;
				background-color: #efeff4;
				border: 1px solid #ddd;
				border-radius: 25px;
				background-clip: padding-box;
				box-shadow: 0 4px 10px #bbb;
				overflow: hidden;
			}
			.mui-pull-top-tips.mui-transitioning {
				-webkit-transition-duration: 200ms;
				transition-duration: 200ms;
			}
			.mui-pull-top-tips .mui-pull-loading {
				/*-webkit-backface-visibility: hidden;
				-webkit-transition-duration: 400ms;
				transition-duration: 400ms;*/
				
				margin: 0;
			}
			.mui-pull-top-wrapper .mui-icon,
			.mui-pull-top-wrapper .mui-spinner {
				margin-top: 7px;
			}
			.mui-pull-top-wrapper .mui-icon.mui-reverse {
				/*-webkit-transform: rotate(180deg) translateZ(0);*/
			}
			.mui-pull-bottom-tips {
				text-align: center;
				background-color: #efeff4;
				font-size: 15px;
				line-height: 40px;
				color: #777;
			}
			.mui-pull-top-canvas {
				overflow: hidden;
				background-color: #fafafa;
				border-radius: 40px;
				box-shadow: 0 4px 10px #bbb;
				width: 40px;
				height: 40px;
				margin: 0 auto;
			}
			.mui-pull-top-canvas canvas {
				width: 40px;
			}
			.mui-slider-indicator.mui-segmented-control {
				background-color: #efeff4;
			}
			.mui-scroll-wrapper{
				z-index: 1;
			}
		</style>
	  
	</head>
	
	<body>
		<header class="mui-bar mui-bar-nav mui-search-box">
			<a href="javascript:void(0);" class="mui-back mui-action-back"></a>
				<h4 class="mui-title">吐槽记录</h4>
		</header>
		<div class="mui-content mui-scroll-wrapper" style="top: 0px;" id="pullrefresh">
			<!--<div class="mui-iframe-wrapper " style="top: 44px;" id="pullrefresh">-->
                                                                            <!--	mui-iframe-wrapper 
                                                                            -->
			<div class="mui-scroll">
			<!--加入群组-->
			<!--<div class="mui-row mui-detail mb10">-->
	<!--<div id="scroll1" class="mui-scroll-wrapper">-->
							
			<ul class="mui-table-view mui-table-view-chevron mui-comment mui-spitslot-lists" id="listDiv">
			
				<li class="mui-table-view-cell mui-media">
					<div class="mui-comment-item">
						<a href="javascript:void(0);" class="mui-comment-zan">
							<!--未点赞-->
							<img src="../images/zan_icon.png" class="icon-zan">
							<!--已点赞-->
							<!--<img src="../images/zanh_icon.png" class="icon-zan">-->
							<b class="zan-num">4</b>
						</a>
						<a href="javascript:void(0);">
							<img class="mui-media-object mui-pull-left mui-comment-logo" src="../images/img1.png">
							<div class="mui-media-body">
								<p class="mui-comment-name"><b class="mui-spitslot-name">爱旅游的小姐</b><b class="mui-spitslot-ticket">风土人情</b></p>
								<b class="mui-comment-time">2017-08-03</b>
							</div>
							<div class="mui-spitslot-con">
								<p>生蚝第一次吃，味道还是很不错，下次再来。哈哈！</p>
							</div>
						</a>
					</div>
				</li>
				<li class="mui-table-view-cell mui-media">
					<div class="mui-comment-item">
						<a href="javascript:void(0);" class="mui-comment-zan">
							<!--未点赞-->
							<!--<img src="../images/zan_icon.png" class="icon-zan">-->
							<!--已点赞-->
							<img src="../images/zanh_icon.png" class="icon-zan">
							<b class="zan-num">4</b>
						</a>
						<a href="javascript:void(0);">
							<img class="mui-media-object mui-pull-left mui-comment-logo" src="../images/img1.png">
							<div class="mui-media-body">
								<p class="mui-comment-name"><b class="mui-spitslot-name">爱旅游的小姐</b><b class="mui-spitslot-ticket">风土人情</b></p>
								<b class="mui-comment-time">2017-08-03</b>
							</div>
							<div class="mui-spitslot-con">
								<p>生蚝第一次吃，味道还是很不错，下次再来。哈哈！</p>
							</div>
						</a>
					</div>
				</li>
			
			</ul>
			</div></div>
		<!--</div>-->


		<!--</div>-->
		<script src="../js/mui.min.js"></script>
	<script src="../../mobile/layer.js"></script>
	<script src="../../js/path.js"></script>
	<script src="../../js/jquery-1.9.1.js"></script>
	<script src="../../hello-mui/js/mui.pullToRefresh.js"></script>
		<script src="../../hello-mui/js/mui.pullToRefresh.material.js"></script>
	<script type="text/javascript" charset="utf-8">
			mui.init(
//				{
//				pullRefresh: {
//					container: '#pullrefresh',
//					down: {
//						style:'circle',
//						color:'#ff0000',
//						callback: pulldownRefresh
//					},
//					up: {
//						auto:true,
//						contentrefresh: '正在加载...',
//						callback: pullupRefresh
//					}
//				}
//			}
				);
			(function($S) {
			var scroll = $S('.mui-scroll-wrapper').scroll({
					indicators: true //是否显示滚动条
				});})(mui);
			var currentInfo = localStorage.getItem("currentInfo");
			console.log(currentInfo)
			if(currentInfo){
				currentInfo = JSON.parse(currentInfo);
				
			//聊天记录div
			var listDiv = document.getElementById("listDiv");
			
			listDiv.innerHTML = "";
			querySpitList(0,3);
				//查询该景点所有详情,通过景点id
			function querySpitList(pageNum,pageSize,_callBack){
			humanAjax(JS_PATH+'/spitslot/queryAll?id='+currentInfo.id,{
							data:{
								pageSize:pageSize,
								pageNum:pageNum
							},
							crossDomain :true,
							dataType:'json',//服务器返回json格式数据
							type:'get',//HTTP请求类型
							success:function(data){
								if(typeof _callBack == 'function')_callBack(data);
								for(var i=0,m=data.length;i<m;i++){
									var item = data[i];
									if(!item.nickname||item.nickname==""){
										item.nickname = '无名氏';
									}
									
									if(!item.publish_time){
										item.publish_time='时间未知'
									}else{
										item.publish_time = item.publish_time.substring(0,10)
									}
									
									listDiv.innerHTML+='<li class="mui-table-view-cell mui-media">'
									+'<div class="mui-comment-item">'
										+'<a href="javascript:void(0);" class="mui-comment-zan" zan_index="'+item.id+'" isThumbsUp="false">'
											+'<!--未点赞-->'
											+'<img src="../images/zan_icon.png" class="icon-zan">'
											+'<!--已点赞-->'
											+'<!--<img src="../images/zanh_icon.png" class="icon-zan">-->'
											+'<b class="zan-num">'+item.point_number+'</b>'
										+'</a>'
										+'<a href="javascript:void(0);">'
											+'<img class="mui-media-object mui-pull-left mui-comment-logo" src="../images/img1.png">'
											+'<div class="mui-media-body">'
												+'<p class="mui-comment-name"><b class="mui-spitslot-name">'+item.nickname+'</b><b class="mui-spitslot-ticket">'+item.name+'</b></p>'
												+'<b class="mui-comment-time">'+item.publish_time+'</b>'
											+'</div>'
											+'<div class="mui-spitslot-con">'
												+'<p>'+item.publish_content+'</p>'
											+'</div>'
										+'</a>'
									+'</div>'
								+'</li>';
								
								}
								
								
								//点赞按钮
								var zanList = document.querySelectorAll('.mui-comment-zan');
								for(var i=0,m=zanList.length;i<m;i++){
									var zan = zanList[i];
									zan.addEventListener('tap',function(){
										//var plist = this.parentNode.parentNode.parentNode.querySelectorAll('.mui-table-view-cell')
										//var pItem = this.parentNode.parentNode;
										var othis = this;
										var zanNum = parseInt($(othis).find('.zan-num').text());
										var parent = $(this).parents('.mui-table-view-cell');
										if($(othis).attr('isThumbsUp')=='false'){
											humanAjax(JS_PATH+'/spitslot/thumbsUp',{
												data:{
													id:$(othis).attr('zan_index'),
													point_number:++zanNum
												},
												crossDomain :true,
												dataType:'json',//服务器返回json格式数据
												type:'post',//HTTP请求类型
												success:function(data){
													if(data.code == 200){
														mui.toast("提交成功");
														$(othis).find('.zan-num').text(zanNum);
														$(othis).find('img').attr('src','../images/zanh_icon.png');
														$(othis).attr('isThumbsUp','true');
													}else{
														mui.toast("提交失败");
													}
													
												},error:function(e){
													mui.toast("系统出错");
												}
											},true,'点赞...');
										}else{//取消点赞
											humanAjax(JS_PATH+'/spitslot/thumbsUp',{
												data:{
													id:$(othis).attr('zan_index'),
													point_number:--zanNum
												},
												crossDomain :true,
												dataType:'json',//服务器返回json格式数据
												type:'post',//HTTP请求类型
												success:function(data){
													if(data.code == 200){
														mui.toast("取消成功");
														$(othis).find('.zan-num').text(zanNum);
														$(othis).find('img').attr('src','../images/zan_icon.png');
														$(othis).attr('isThumbsUp','false');
													}else{
														mui.toast("提交失败");
													}
													
												},error:function(e){
													mui.toast("系统出错");
												}
											},true,'点赞取消...');
										}
										
									});
								}
							},error:function(e){
								if(typeof _callBack == 'function')_callBack(e);
							}
						},false,'更新...');
						
						
				}		
						
			}
			
			
//			var count = 0;
//			function pullupRefresh() {
//				console.log('上拉');
//				alert('上拉')
//				setTimeout(function() {
//					//mui('#pullrefresh').pullRefresh().endPullup((++count > 2)); //参数为true代表没有更多数据了。
//					mui('#pullrefresh').pullRefresh().endPullupToRefresh();
//					
//				}, 1500);
//			}
//			
//			/**
//			 * 下拉刷新具体业务实现
//			 */
//			function pulldownRefresh() {
//				console.log('下拉');
//				alert('下拉')
//				setTimeout(function() {
//					mui('#pullrefresh').pullRefresh().endPulldownToRefresh();
//					
//				}, 1500);
//			}
//			var mui_scroll_wrapper = document.querySelectorAll('.mui-scroll-wrapper');
//			var isGo = false;
//			for(var i=0,m=mui_scroll_wrapper.length;i<m;i++){
//				mui_scroll_wrapper[i].addEventListener('scroll', function (e ) { 
////					alert(e.detail.y);
////				      console.log(e.detail.y,document.body.scrollTop,isGo);
//				     if(e.detail.y>0 && !isGo){
////				     	document.body.scrollTop = 0;
//						isGo = true;
//				     }else if(e.detail.y<-100 && !isGo){
//				     	isGo = true;
////				     	document.body.scrollTop = 130;
//
//				     }
//				}) 
//			}
			
			
			
			//滚动加载上拉下拉刷新
			
			(function($) {
				//阻尼系数
				var deceleration = mui.os.ios?0.003:0.0009;
				$('.mui-scroll-wrapper').scroll({
					bounce: false,
					indicators: true, //是否显示滚动条
					deceleration:deceleration
				});
				
				var pageNum=0;
				$.ready(function() {
					//循环初始化所有下拉刷新，上拉加载。
					$.each(document.querySelectorAll('.mui-scroll-wrapper .mui-scroll'), function(index, pullRefreshEl) {
						$(pullRefreshEl).pullToRefresh({
//							down: {
//								callback: function() {
//									var self = this;
//									console.log('下拉');
//									setTimeout(function() {
//										var ul = self.element.querySelector('.mui-table-view');
////										ul.insertBefore(createFragment(ul, index, 10, true), ul.firstChild);
////										self.endPullDownToRefresh();
//									}, 1000);
//								}
//							},
							up: {
								callback: function() {
									var self = this;
									console.log('上拉');
									pageNum++;
									querySpitList(pageNum,3,function(v){
										
										
										
										setTimeout(function() {
//											ul.appendChild(createFragment(ul, index, 5));
											if(!v||v.length<1)
												self.endPullUpToRefresh(true);
											else
												self.endPullUpToRefresh(false);
										}, 1500);
									});
									
								}
							}
						});
					});
					var createFragment = function(ul, index, count, reverse) {
						var length = ul.querySelectorAll('li').length;
						var fragment = document.createDocumentFragment();
						var li;
						
						return fragment;
					};
				});
			})(mui);
	</script>
	</body>
</html>
